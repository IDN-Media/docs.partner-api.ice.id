# Chat Module

## Chat API

### Get/create Chat Room

`GET /chats/joinChatRoom`

#### Query Params

| Key                | Required | Description                                                                      |
| ------------------ | :------: | -------------------------------------------------------------------------------- |
| `roomName`         |   yes    | Chat Room Name                                                                   |
| `userId`           |   yes    | User ID for chat room                                                            |
| `email`            |   yes    | User Email                                                                       |
| `userName`         |          | User Name to show on chat room. If omitted, User Email will be used as User Name |
| `messageCount`     |          | Number of last message retrieved, if any. Default = 10                           |
| `userProfileImage` |          | URL of user profile image (avatar)                                               |

#### Response

```typescript
{
  token: string;
  userId: string;
  roomId: string;
  roomName: string;
  lastMessages?: {
    payload: string;
    id: string;
    sortkey: string;
  }[];
  messageLastKey?: {
    id: string;
    sortkey: string;
  };
}
```

#### Notes
- Room name : I_[influencerId]\_C\_[campaignId]
- User type : I (Influencer), B (Business User), ICE (ICE Ops)
- UserId format : [userType]_[userId]
  - I_40 : influencer with id 40
  - ICE_105 : influencer with id 105
  - etc…

### Get chat message history

`GET /rooms/listMessageHistory`

#### Query Params

| Key            | Required | Description                                       |
| -------------- | :------: | ------------------------------------------------- |
| `roomName`     |   yes    | Chat Room Name                                    |
| `lastId`       |   yes    | `id` value from `messageLastKey` object           |
| `lastSortkey`  |   yes    | `sortkey` value from `messageLastKey` object      |
| `messageCount` |          | Number of message retrieved, if any. Default = 10 |

#### Response

```typescript
{
  items?: {
    payload: string;
    id: string;
    sortkey: string;
  }[];
  messageLastKey?: {
    id: string;
    sortkey: string;
  };
}
```

### Generate Presigned URL for Uploading File

`POST /chats/generateUploadUrl`

#### Payload

```typescript
{
  "roomName": "chat_room_01",
  "fileExtension": "jpeg"
}
```

#### Response

```typescript
{
  "uploadUrl": string,
  "fileKey": string
}
```

### Get Presigned URL for Downloading/Open File

`GET /chats/getSignedUrl`

#### Query Params

| Key   | Required | Description |
| ----- | :------: | ----------- |
| `key` |   yes    | Object key  |

#### Response

```typescript
"https://bucket-name.s3.us-east-1.amazonaws.com/I_191_C_184/chat-80b474iah.jpeg?X-Amz-Algorithm=AWS4-HMAC-SHA256...&x-id=GetObject"
```

## Chat Client

### Connect and Listen to Room

```typescript
const websocketUrl = 'wss://edge.ivschat.us-east-1.amazonaws.com';

// connecting to room
// token retrieved from /rooms/getOrCreateChatRoom response
const connection = new WebSocket(websocketUrl, token);

// listen to message
connection.onmessage = ((event:MessageEvent) => {
  console.log('chat event : ', JSON.parse(event.data.toString()));
})

// listen to error
connection.onerror = (event:ErrorEvent) => {
  console.log(`CONN ERR FOR ${userId}`);
}
```

### Chat Event

#### _onmessage_ Payload

```typescript
{
  Type: 'MESSAGE',
  Id: 'kbGr3bJMBr4k',
  RequestId: 'sktwi4y7ldafi6mh',
  Attributes: {
    MessageType: 'TEXT',
    RoomName: 'daniel_test',
    SendTime: '2023-01-24T16:05:20.776Z',
    IsUploading: true,
    FileUrl: '',
    FileType: ''
    UniqueId: 'sktwi4y7ldafi6mh'
  },
  Content: 'message from I_1 at 2023-01-24T16:05:20.776Z',
  SendTime: '2023-01-24T16:05:20.929415954Z',
  Sender: {
    UserId: 'I_1',
    Attributes: {
      email: 'user1@email.com',
      iceUserId: '1',
      iceUserType: 'INFLUENCER',
      userName: 'Influencer 001'
    }
  }
}
```

| Key                | Description                                                                  |
| ------------------ | ---------------------------------------------------------------------------- |
| `event.Type`       | `MESSAGE`                                                                    |
| `event.Id`         | An identifier generated by Amazon IVS Chat                                   |
| `event.RequestId`  | An identifier optionally specified by your application for tracking purposes |
| `event.Attributes` | Object contains details of the event                                         |
| `event.Content`    | Content of the chat message                                                  |
| `event.SendTime`   | Timestamp of when the message was received by Amazon IVS Chat                |
| `event.Sender`     | Object contains information about the message sender                         |

| Key                            | Description                                                                  |
| ------------------------------ | ---------------------------------------------------------------------------- |
| `event.Attributes.MessageType` | Type of sent message. (`TEXT` \| `IMAGE` \| `DOCUMENT`)                      |
| `event.Attributes.RoomName`    | Name of chat room                                                            |
| `event.Attributes.SendTime`    | Timestamp of when the message was sent by user                               |
| `event.Attributes.IsUploading` | Image/document uploading status                                              |
| `event.Attributes.FileUrl`     | URL of the uploaded image/document                                           |
| `event.Attributes.FileType`    | Image type of the uploaded image/document                                    |
| `event.Attributes.UniqueId`    | An identifier optionally specified by your application for tracking purposes |

| Key                       | Description                           |
| ------------------------- | ------------------------------------- |
| `event.Sender.UserId`     | User ID of message sender             |
| `event.Sender.Attributes` | Object contains details of the sender |

| Key                                   | Description                                                       |
| ------------------------------------- | ----------------------------------------------------------------- |
| `event.Sender.Attributes.email`       | Email of the sender                                               |
| `event.Sender.Attributes.iceUserId`   | Id of the sender based on their respective user type              |
| `event.Sender.Attributes.iceUserType` | Type of the sender (`INFLUENCER` \| `BUSINESS_USER` \| `ICE_OPS`) |
| `event.Sender.Attributes.userName`    | Name of the sender                                                |

#### _onerror_ Payload

```typescript
{
  ErrorCode: 406,
  ErrorMessage: "Content length is invalid (1-300 characters)"
  Id: "xTUET9fgwZ7Q",
  RequestId: "l8toq05c",
  Type: "ERROR",
}
```

| Key            | Description                                                                  |
| -------------- | ---------------------------------------------------------------------------- |
| `ErrorCode`    | Error code (see below)                                                       |
| `ErrorMessage` | Descriptive error message                                                    |
| `Id`           | Identifier of the operation that caused this error                           |
| `RequestId`    | An identifier optionally specified by your application for tracking purposes |
| `Type`         | `ERROR`                                                                      |

| Error                 | Error Code | Description                                                                     |
| --------------------- | ---------- | ------------------------------------------------------------------------------- |
| Bad Request           | 400        | The request is malformed or invalid                                             |
| Unauthorized          | 401        | The connection has expired or the chat token is missing                         |
| Forbidden             | 403        | The connection’s capabilities do not permit this action, or the user is blocked |
| Not Found             | 404        | The room cannot be found (does not exist)                                       |
| Too Many Requests     | 429        | The application has exceeded rate limits                                        |
| Internal Server Error | 500        | This is returned for a general error                                            |

### Send Text Message

```typescript
const sendText = async (value:string, connection:Websocket, roomName:string) => {
  const textValue = value || "";
  if (textValue.length <= 0) {
    return;
  }

  // manually generate request id
  const requestId = uniqid();

  const ivsChatPayload = {
    Action: "SEND_MESSAGE",
    Attributes: {
      MessageType: "TEXT",
      SendTime: new Date().toISOString(),
      RoomName: roomName,
      UniqueId: requestId
    },
    Content: textValue,
    RequestId: requestId
  }

  connection.send(JSON.stringify(ivsChatPayload));
}
```

### Send File Message

#### Send Uploading in Progress Info

```typescript
type MessageType = 'IMAGE' | 'DOCUMENT';

const sendUploadInfo = async (messageType:MessageType, roomName:string, connection:Websocket) => {
  const requestId = uniqid();

  const ivsChatPayload = {
    Action: "SEND_MESSAGE",
    Attributes: {
      MessageType: messageType,
      SendTime: new Date().toISOString(),
      RoomName: roomName,
      IsUploading: true,
      FileUrl: "",
      FileType: "",
      UniqueId: requestId
    },
    Content: '',
    RequestId: requestId
  }

  connection.send(JSON.stringify(ivsChatPayload));

  return requestId;
}
```

#### Send Upload Complete

```typescript
type MessageType = 'IMAGE' | 'DOCUMENT';

const sendUploadComplete = async (uniqueId:string, fileUrl:string, messageType:MessageType, fileType:string, roomName:string, connection:Websocket) {
  if(textValue.length <= 0){
    return;
  }
  const requestId = uniqueId;

  const ivsChatPayload = {
    Action: "SEND_MESSAGE",
    Attributes: {
      MessageType: messageType,
      SendTime: phase1Message.SendTime,
      RoomName: roomName,
      IsUploading: true,
      FileUrl: "",
      FileType: "",
      UniqueId: uniqueId
    },
    Content: '',
    RequestId: requestId
  }

  connection.send(JSON.stringify(ivsChatPayload));
}
```

## Diagrams

### Get Room Credentials

![get room credential](get-room.jpg)

### Send Message

![send message](send-message.jpg)

### Event Handling
![event handling](event-handling.jpg)
